<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimal-ui">
    <meta http-equiv="Accept-Encoding" content="gzip, deflate, br">
    <meta name="description" content="Gumball Game - Fast Loading Optimized Version">
    
    <title>Gumball</title>

    <!-- Preload critical resources -->
    <link rel="preload" href="css/fonts.css" as="style">
    <link rel="preload" href="css/game.css" as="style">
    <link rel="preload" href="js/libs/createjs-2013.12.12.min.js" as="script">
    <link rel="preload" href="images/game/interface/logo_cn.png" as="image">
    
    <!-- Critical CSS - inline for faster loading -->
    <style>
        /* Critical above-the-fold styles */
        body {
            margin: 0;
            padding: 0;
            background: #72CFE9;
            font-family: 'gumball', Arial, sans-serif;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game {
            position: relative;
        }
        
        .canvasGame {
            display: block;
            background: #72CFE9;
        }
        
        /* Loading screen optimization */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #72CFE9 0%, #5BA8D1 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #F856A2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #F856A2;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        
        .loading-progress {
            width: 200px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #F856A2, #FF6B9D);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }
    </style>

    <!-- Load CSS asynchronously -->
    <link href="css/fonts.css" rel="stylesheet" type="text/css" media="all">
    <link href="css/game.css" rel="stylesheet" type="text/css" media="all">
</head>
<body>
    <!-- Fast loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Game...</div>
        <div class="loading-progress">
            <div id="loading-progress-bar" class="loading-progress-bar"></div>
        </div>
        <div id="loading-percentage" style="color: white; margin-top: 10px; font-size: 14px;">0%</div>
    </div>

    <div class="container">
        <div class="game">
            <canvas id="canvasGame" class="canvasGame"></canvas>
        </div>
    </div>

    <!-- Wisetrack configuration -->
    <script>
        var config = config || {};
        config.language_code = 'en_GB';
        config.wisetrack = 'WISETRACK_1732_3c3388ae75';
        
        // Performance optimization flags
        config.optimizedLoading = true;
        config.lazyLoadAudio = true;
        config.progressiveLoading = true;
    </script>

    <!-- Critical JavaScript - Load immediately -->
    <script>
        // Fast loading progress updater
        function updateLoadingProgress(percentage) {
            const progressBar = document.getElementById('loading-progress-bar');
            const percentageText = document.getElementById('loading-percentage');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            if (percentageText) {
                percentageText.textContent = Math.round(percentage) + '%';
            }
        }
        
        // Hide loading screen when complete
        function hideLoadingScreen() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);
            }
        }
        
        // Performance monitoring
        const loadStartTime = performance.now();
        window.addEventListener('load', () => {
            const loadTime = performance.now() - loadStartTime;
            console.log(`Game loaded in ${Math.round(loadTime)}ms`);
        });
    </script>

    <!-- Core libraries - Load first -->
    <script type="text/javascript" src="js/libs/createjs-2013.12.12.min.js"></script>
    <script type="text/javascript" src="js/libs/jquery-1.11.1.min.js"></script>
    
    <!-- Performance optimizer - Load early -->
    <script type="text/javascript" src="js/performance-optimizer.js"></script>
    
    <!-- Essential utilities -->
    <script type="text/javascript" src="js/libs/Utils.js"></script>
    <script type="text/javascript" src="js/libs/CopyParser.js"></script>
    <script type="text/javascript" src="js/libs/SoundsManager.js"></script>
    
    <!-- Core game modules - Critical path -->
    <script type="text/javascript" src="js/gumball/Navigation.js"></script>
    <script type="text/javascript" src="js/gumball/screens/ScreenPreload.js"></script>
    <script type="text/javascript" src="js/gumball/Main.js"></script>
    
    <!-- Interface components - High priority -->
    <script type="text/javascript" src="js/gumball/interface/GameLogo.js"></script>
    <script type="text/javascript" src="js/gumball/interface/BtnPlay.js"></script>
    <script type="text/javascript" src="js/gumball/screens/ScreenFront.js"></script>
    <script type="text/javascript" src="js/gumball/screens/ScreenRotate.js"></script>
    
    <!-- Game core - Medium priority -->
    <script type="text/javascript" src="js/gumball/game/Status.js"></script>
    <script type="text/javascript" src="js/gumball/game/Hud.js"></script>
    <script type="text/javascript" src="js/gumball/game/controllers/ControllerKeyboard.js"></script>
    <script type="text/javascript" src="js/gumball/game/controllers/ControllerTouch.js"></script>
    
    <!-- Game objects - Defer loading -->
    <script type="text/javascript" src="js/gumball/game/objects/Hero.js" defer></script>
    <script type="text/javascript" src="js/gumball/game/objects/Customer.js" defer></script>
    <script type="text/javascript" src="js/gumball/game/objects/Veg.js" defer></script>
    <script type="text/javascript" src="js/gumball/screens/ScreenGame.js" defer></script>
    <script type="text/javascript" src="js/gumball/screens/ScreenInstructions.js" defer></script>
    
    <!-- Secondary features - Lazy load -->
    <script type="text/javascript" src="js/gumball/interface/BtnContinue.js" defer></script>
    <script type="text/javascript" src="js/gumball/interface/BtnPlayAgain.js" defer></script>
    <script type="text/javascript" src="js/gumball/interface/SummaryScore.js" defer></script>
    <script type="text/javascript" src="js/gumball/game/objects/Money.js" defer></script>
    <script type="text/javascript" src="js/gumball/game/objects/PointsCloud.js" defer></script>
    <script type="text/javascript" src="js/gumball/screens/ScreenSummary.js" defer></script>
    <script type="text/javascript" src="js/gumball/screens/ScreenFailed.js" defer></script>
    <script type="text/javascript" src="js/gumball/screens/ScreenWin.js" defer></script>
    
    <!-- Collision detection - Load when needed -->
    <script type="text/javascript" src="js/libs/Collision.js" defer></script>
    <script type="text/javascript" src="js/libs/ndgmr.Collision.js" defer></script>
    <script type="text/javascript" src="js/libs/matchMedia.js" defer></script>
    <script type="text/javascript" src="js/libs/modernizr.js" defer></script>

    <!-- Service Worker for caching (if supported) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
